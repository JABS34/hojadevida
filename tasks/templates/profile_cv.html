<div id="modalCert" class="fixed inset-0 bg-black/90 hidden z-[70] flex items-center justify-center p-6 no-print">
    <div class="bg-white rounded-3xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">
        <div class="p-6 border-b flex justify-between items-center bg-slate-50">
            <h2 class="text-2xl font-bold text-indigo-900"><i class="fas fa-certificate mr-2"></i> Mis Cursos y Certificados</h2>
            <button onclick="closeModal('modalCert')" class="text-slate-400 hover:text-red-500 text-2xl transition">&times;</button>
        </div>
        <div class="modal-content overflow-y-auto p-8 grid grid-cols-1 md:grid-cols-2 gap-8">
            {% for cert in certificados %}
            <div class="group cursor-pointer" onclick="verCertificado('{{ cert.imagen.url }}', '{{ cert.titulo }}')">
                <p class="font-bold text-slate-700 mb-2 group-hover:text-indigo-600 transition">{{ cert.titulo }}</p>
                <div class="relative overflow-hidden rounded-xl border shadow-md">
                    <img src="{{ cert.imagen.url }}" class="w-full hover:scale-110 transition duration-500">
                    <div class="absolute inset-0 bg-indigo-600/20 opacity-0 group-hover:opacity-100 transition flex items-center justify-center">
                        <span class="bg-white text-indigo-600 px-4 py-2 rounded-full font-bold shadow-lg text-xs">VER PREVIA</span>
                    </div>
                </div>
            </div>
            {% empty %}
            <p class="col-span-full text-center text-slate-500 italic">No hay certificados cargados.</p>
            {% endfor %}
        </div>
    </div>
</div>

<div id="visorCert" class="fixed inset-0 bg-black/95 hidden z-[80] flex items-center justify-center p-4 no-print">
    <div class="absolute top-5 right-5 flex gap-4">
        <a id="btnDescargar" href="#" download class="bg-white text-slate-900 px-6 py-3 rounded-xl font-bold flex items-center gap-2 hover:bg-indigo-50 transition shadow-2xl">
            <i class="fas fa-download text-red-600"></i> DESCARGAR PDF
        </a>
        <button onclick="closeModal('visorCert')" class="bg-white/10 text-white w-12 h-12 rounded-xl flex items-center justify-center hover:bg-red-600 transition">
            <i class="fas fa-times text-xl"></i>
        </button>
    </div>
    
    <div class="max-w-5xl w-full flex flex-col items-center">
        <h3 id="tituloVisor" class="text-white text-xl font-bold mb-6 italic tracking-wider"></h3>
        <img id="imgVisor" src="" class="max-w-full max-h-[75vh] rounded-lg shadow-2xl border border-white/10">
    </div>
</div>

<script>
    function openModal(id) { 
        document.getElementById(id).classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
    
    function closeModal(id) { 
        document.getElementById(id).classList.add('hidden');
        if(id !== 'visorCert') document.body.style.overflow = 'auto';
    }

    // Nueva función para la vista previa
    function verCertificado(url, titulo) {
        document.getElementById('imgVisor').src = url;
        document.getElementById('tituloVisor').innerText = titulo;
        
        // El botón de descarga apunta a la URL de la imagen
        // Los navegadores modernos permiten descargar imágenes como archivos al usar el atributo 'download'
        document.getElementById('btnDescargar').href = url;
        document.getElementById('btnDescargar').download = "Certificado_" + titulo.replace(/\s+/g, '_') + ".jpg";
        
        openModal('visorCert');
    }

    // Cerrar con tecla Escape
    document.addEventListener('keydown', (e) => {
        if (e.key === "Escape") {
            closeModal('visorCert');
            closeModal('modalCert');
            closeModal('modalRec');
            closeModal('modalPDF');
        }
    });

    function generarPDF() {
        const s_mi = document.getElementById('check_sobre_mi').checked;
        const curs = document.getElementById('check_cursos').checked;
        const url = "{% url 'export_pdf' user_viewed.username %}?sobre_mi=" + s_mi + "&cursos=" + curs;
        window.open(url, '_blank');
    }
</script>
